# =============================================================================
# Nginx Load Balancer Configuration
# =============================================================================
# This file is deployed on the Load Balancer server
# Location: /etc/nginx/sites-available/app-lb
# Enable: sudo ln -s /etc/nginx/sites-available/app-lb /etc/nginx/sites-enabled/
#
# IMPORTANT: Update the IP addresses below with your actual server IPs
# Or use the Ansible playbook which generates this from the template.
# =============================================================================

# Define backend servers
upstream app_backend {
    # Primary server - UPDATE WITH YOUR PRIMARY_HOST IP
    server PRIMARY_HOST_IP:3000 max_fails=3 fail_timeout=10s;

    # Standby server - UPDATE WITH YOUR BACKUP_HOST IP
    server BACKUP_HOST_IP:3000 backup max_fails=3 fail_timeout=10s;
}

# Server block
server {
    # Listen on port 80 (HTTP) and port 3000
    listen 80;
    listen 3000;

    # Accept requests for any server name
    # Or set to your domain: server_name yourdomain.com www.yourdomain.com;
    server_name _;

    # Main application proxy
    location / {
        # Forward requests to backend servers
        proxy_pass http://app_backend;

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;

        # Retry on next server if current fails
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
