# Nginx Load Balancer Configuration
# This file is deployed on VCL1 (Router) at: /etc/nginx/sites-available/coffee-lb
#
# Purpose: Distributes traffic between VCL2 (primary) and VCL3 (standby)
# Location on VCL1: /etc/nginx/sites-available/coffee-lb
# Enabled at: /etc/nginx/sites-enabled/coffee-lb

# Define backend servers
upstream coffee_backend {
    # Primary server (VCL2)
    server 152.7.178.106:3000 max_fails=3 fail_timeout=10s;

    # Standby server (VCL3) - only used if primary fails
    server 152.7.178.91:3000 backup max_fails=3 fail_timeout=10s;
}

# Server block
server {
    # Listen on port 80 (HTTP) and port 3000
    listen 80;
    listen 3000;

    # Accept requests for any server name
    server_name _;

    # Main application proxy
    location / {
        # Forward requests to backend servers
        proxy_pass http://coffee_backend;

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;

        # Retry on next server if current fails
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
