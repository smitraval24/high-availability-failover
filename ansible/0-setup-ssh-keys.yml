---
# Setup SSH Keys and Passwordless Authentication
# Run this FIRST with password authentication, then all other playbooks work passwordless
#
# Usage:
#   ansible-playbook -i inventory.yml 0-setup-ssh-keys.yml --ask-pass --ask-become-pass
#
# This will prompt for your password once, then setup passwordless SSH for all future operations

- name: Setup SSH Keys for Passwordless Authentication
  hosts: localhost
  gather_facts: no
  connection: local

  tasks:
    - name: Check if SSH key exists
      stat:
        path: ~/.ssh/id_ed25519
      register: ssh_key

    - name: Generate SSH key if not exists
      shell: ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519
      when: not ssh_key.stat.exists

    - name: Display SSH key location
      debug:
        msg: "SSH key exists at ~/.ssh/id_ed25519"

- name: Disable Firewall Temporarily (Using Password Auth)
  hosts: all
  gather_facts: no
  become: yes

  tasks:
    - name: Check if UFW is active
      shell: ufw status | grep -q "Status: active"
      register: ufw_status
      ignore_errors: yes
      changed_when: false

    - name: Disable UFW firewall
      command: ufw --force disable
      when: ufw_status.rc == 0
      ignore_errors: yes

    - name: Display firewall status
      debug:
        msg: "Firewall disabled on {{ inventory_hostname }}"

- name: Copy SSH Keys to All Servers
  hosts: all
  gather_facts: no

  tasks:
    - name: Ensure .ssh directory exists
      file:
        path: ~/.ssh
        state: directory
        mode: '0700'

    - name: Copy SSH public key to authorized_keys
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"

    - name: Display success message
      debug:
        msg: "SSH key installed on {{ inventory_hostname }}"

- name: Test Passwordless SSH
  hosts: all
  gather_facts: no

  tasks:
    - name: Test SSH connection
      ping:

    - name: Display connection success
      debug:
        msg: "✓ Passwordless SSH working on {{ inventory_hostname }}"

- name: Summary
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Display setup complete message
      debug:
        msg:
          - "=========================================="
          - "  SSH KEYS SETUP COMPLETE!"
          - "=========================================="
          - ""
          - "✓ SSH keys generated"
          - "✓ Keys copied to all servers"
          - "✓ Firewalls disabled temporarily"
          - "✓ Passwordless authentication enabled"
          - ""
          - "You can now run other playbooks without --ask-pass:"
          - ""
          - "  ansible-playbook -i inventory.yml site.yml"
          - ""
          - "The site.yml playbook will re-enable firewalls with proper security!"
          - "=========================================="
