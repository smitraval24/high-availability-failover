---
# Database Replication Setup
# This playbook sets up database replication from VCL2 to VCL3

- name: Setup Database Replication (VCL2 â†’ VCL3)
  hosts: vcl2
  gather_facts: no

  tasks:
    - name: Create replication scripts directory
      file:
        path: /home/{{ ansible_user }}/scripts
        state: directory
        mode: '0755'

    - name: Copy database replication script to VCL2
      copy:
        dest: /home/{{ ansible_user }}/scripts/sync-db-to-vcl3.sh
        mode: '0755'
        content: |
          #!/bin/bash
          # Sync database from VCL2 to VCL3
          # This stores backups on VCL3 for failover use
          # The monitor script will restore when failover is triggered

          VCL3_HOST="{{ hostvars['vcl3']['ansible_host'] }}"
          VCL3_USER="{{ ansible_user }}"
          BACKUP_DIR="/tmp/db-backup"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="coffee_db_${TIMESTAMP}.sql"
          DB_NAME="coffee_dev"

          log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
          }

          log "Starting database replication to VCL3..."

          # Create backup directory locally
          mkdir -p $BACKUP_DIR

          # Dump database from VCL2
          log "Creating database dump..."
          if sudo docker exec coffee_db pg_dump -U postgres ${DB_NAME} > "${BACKUP_DIR}/${BACKUP_FILE}"; then
              log "Database dump created: ${BACKUP_FILE}"
          else
              log "ERROR: Failed to create database dump"
              exit 1
          fi

          # Ensure backup directory exists on VCL3
          log "Ensuring backup directory exists on VCL3..."
          ssh -o StrictHostKeyChecking=no ${VCL3_USER}@${VCL3_HOST} "mkdir -p ${BACKUP_DIR}"

          # Copy to VCL3
          log "Copying database dump to VCL3..."
          if scp -o StrictHostKeyChecking=no "${BACKUP_DIR}/${BACKUP_FILE}" ${VCL3_USER}@${VCL3_HOST}:${BACKUP_DIR}/; then
              log "Database dump copied to VCL3: ${BACKUP_DIR}/${BACKUP_FILE}"
          else
              log "ERROR: Failed to copy database dump to VCL3"
              exit 1
          fi

          # Note: We don't restore on VCL3 here because:
          # 1. VCL3 is in standby mode (no running containers)
          # 2. The monitor script will restore from backup during failover
          log "Backup stored on VCL3 for failover use"

          # Cleanup old backups (keep last 5 on both servers)
          log "Cleaning up old backups..."
          cd $BACKUP_DIR
          ls -t coffee_db_*.sql 2>/dev/null | tail -n +6 | xargs -r rm
          ssh -o StrictHostKeyChecking=no ${VCL3_USER}@${VCL3_HOST} \
              "cd ${BACKUP_DIR} && ls -t coffee_db_*.sql 2>/dev/null | tail -n +6 | xargs -r rm" || true

          log "Database replication completed successfully"
          log "Backup available on VCL3: ${BACKUP_DIR}/${BACKUP_FILE}"

    - name: Setup SSH key for passwordless replication
      shell: |
        if [ ! -f ~/.ssh/id_rsa ]; then
          ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
        fi
        ssh-copy-id -o StrictHostKeyChecking=no {{ ansible_user }}@{{ hostvars['vcl3']['ansible_host'] }} || true
      args:
        executable: /bin/bash
      ignore_errors: yes

    - name: Create cron job for automatic replication
      cron:
        name: "Database replication to VCL3"
        minute: "*/30"
        job: "/home/{{ ansible_user }}/scripts/sync-db-to-vcl3.sh >> /var/log/db-replication.log 2>&1"
        state: present

    - name: Test replication script
      shell: /home/{{ ansible_user }}/scripts/sync-db-to-vcl3.sh
      args:
        executable: /bin/bash
      register: replication_test
      ignore_errors: yes

    - name: Display replication test result
      debug:
        msg:
          - "Database replication setup complete!"
          - "Runs every 30 minutes via cron"
          - "Manual run: /home/{{ ansible_user }}/scripts/sync-db-to-vcl3.sh"
          - "Logs: /var/log/db-replication.log"
