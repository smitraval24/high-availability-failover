---
# Ansible Playbook: Deploy Coffee App to VCL2
# Usage: ansible-playbook -i inventory.yml deploy.yml

- name: Deploy Coffee App to VCL2
  hosts: vcl2
  gather_facts: no

  tasks:
    - name: Pull latest code from GitHub
      shell: |
        cd /home/{{ ansible_user }}/devops-project
        git pull origin main
      args:
        executable: /bin/bash

    - name: Stop old Docker containers
      shell: |
        cd /home/{{ ansible_user }}/devops-project/coffee_project
        sudo docker compose down
      args:
        executable: /bin/bash
      ignore_errors: yes

    - name: Remove broken Docker iptables chains
      shell: |
        iptables -t filter -F DOCKER-ISOLATION-STAGE-1
        iptables -t filter -X DOCKER-ISOLATION-STAGE-1
        iptables -t filter -F DOCKER-ISOLATION-STAGE-2
        iptables -t filter -X DOCKER-ISOLATION-STAGE-2
        iptables -t nat -F DOCKER
        iptables -t nat -X DOCKER
        iptables -t filter -F DOCKER
        iptables -t filter -X DOCKER
      ignore_errors: yes
      become: yes

    - name: Restart Docker service to fix iptables
      become: yes
      service:
        name: docker
        state: restarted
      ignore_errors: yes

    - name: Wait for Docker to start
      pause:
        seconds: 10

    - name: Build and start new containers
      shell: |
        cd /home/{{ ansible_user }}/devops-project/coffee_project
        sudo docker compose up -d --build
      args:
        executable: /bin/bash

    - name: Wait for application to start
      wait_for:
        port: 3000
        host: "{{ ansible_host }}"
        timeout: 30
        delay: 5

    - name: Run health check
      uri:
        url: "http://{{ ansible_host }}:3000/coffees"
        status_code: 200
      register: health_check
      retries: 5
      delay: 3
      until: health_check.status == 200

    - name: Display deployment status
      debug:
        msg: "âœ“ Deployment successful! App is running at http://{{ ansible_host }}:3000"
